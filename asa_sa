#!/bin/sh

#echo Generate SA configs for an asa
#echo by William Burns

LIVE=false
LIVE=true

# A security association defines the parameters for a one-way tunnel
# Not that you could tell that by looking at ciscoland config files.

TUN_NUMBER=${1:-100}

# Local Network
LOC_NET=${2:-172.16.2.0}
LOC_MASK=${3:-255.255.255.0}
LOC_OUT_ADD=${4:-192.168.1.2}
LOC_GATE=${5:-192.168.1.1}

# Remote Network
REM_NET=${6:-10.192.0.0}
REM_MASK=${7:-255.255.0.0}
REM_PEER=${8:-192.168.1.1}

PRESHAREDKEY=${9:-UseABetterPassword}

echo "! global isakmp configs"
echo "crypto isakmp enable outside"

echo "crypto isakmp policy 10"
echo " authentication pre-share"
echo " encryption 3des"
echo " hash sha"
echo " group 2"
echo " lifetime 86400"
$LIVE && echo " exit"

echo "crypto ipsec transform-set myset esp-3des esp-sha-hmac"

echo
echo "! per tunnel config"
echo "! generated by ./asa_sa $TUN_NUMBER $LOC_NET $LOC_MASK $LOC_GATE $REM_NET $REM_MASK $REM_PEER"
echo "! Tunnel from ${LOC_NET} $LOC_MASK to $REM_NET $REM_MASK through gateway $LOC_GATE to remote peer $REM_PEER"

#echo "access-list ${TUN_NAME}acl extended deny ip $LOC_NET $LOC_MASK $REM_PEER 255.255.255.255
echo "access-list tun${TUN_NUMBER}acl extended permit ip $LOC_NET $LOC_MASK $REM_NET $REM_MASK"
echo "access-list tun${TUN_NUMBER}acl extended deny ip $LOC_OUT_ADD 255.255.255.255 $REM_PEER 255.255.255.255"
echo "access-list tun${TUN_NUMBER}acl extended permit ip $LOC_NET $LOC_MASK $REM_PEER 255.255.255.255"
echo "access-list tun${TUN_NUMBER}acl extended permit ip $LOC_OUT_ADD 255.255.255.255 $REM_NET $REM_MASK"
echo "! Do you need to add a route?"
echo "! route outside $REM_NET $REM_MASK $LOC_GATE"

#echo "crypto map ${TUN_NAME}map 20 match address ${TUN_NAME}acl"
echo "crypto map ipsecmap ${TUN_NUMBER} match address tun${TUN_NUMBER}acl"
echo "crypto map ipsecmap ${TUN_NUMBER} set peer $REM_PEER"
echo "crypto map ipsecmap ${TUN_NUMBER} set transform-set myset"

echo "crypto map ipsecmap interface outside"

echo "tunnel-group $REM_PEER type ipsec-l2l"
echo "tunnel-group $REM_PEER ipsec-attributes"
echo " pre-shared-key $PRESHAREDKEY"
$LIVE && echo " exit"
